<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Scene with Lottie Animation and 3D Model</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.7.14/lottie.min.js"></script>
    <style>
        #arjsDebugUIContainer {
            display: none;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
        <a-assets>
            <!-- Add your 3D model here -->
            <a-asset-item id="car-model" src="https://abhi-000.github.io/ArMenuPoc/Models/scene.gltf"></a-asset-item>
        </a-assets>

        <a-marker type="pattern" url="https://abhi-000.github.io/ArMenuPoc/Markers/pattern-trialMenu.patt">
            <a-entity id="scene-container" position="0 0 0">
                <!-- Lottie animation container -->
                <a-entity id="lottie-container" position="0 0 0" rotation="-90 0 0">
                    <a-plane id="lottie-plane" width="4" height="2" material="transparent: true; opacity: 0"></a-plane>
                </a-entity>
                
                <!-- 3D model container (initially hidden) -->
                <a-entity id="model-container" position="0 0.5 0" scale="0.5 0.5 0.5" visible="false">
                    <a-entity gltf-model="#car-model" rotation="0 0 0"></a-entity>
                </a-entity>
            </a-entity>
        </a-marker>
        
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        AFRAME.registerComponent('lottie-animation', {
            init: function() {
                this.container = document.createElement('div');
                this.container.style.position = 'absolute';
                this.container.style.top = '0';
                this.container.style.left = '0';
                this.container.style.pointerEvents = 'auto';  // Make it clickable
                document.body.appendChild(this.container);

                this.animation = lottie.loadAnimation({
                    container: this.container,
                    renderer: 'svg',
                    loop: true,
                    autoplay: false,
                    path: 'https://lottie.host/5d18314e-1e0b-4168-a1bb-8f00682e0d80/NySQaykTI3.json'
                });

                this.el.sceneEl.addEventListener('markerFound', () => {
                    this.animation.play();
                    this.container.style.display = 'block';
                });

                this.el.sceneEl.addEventListener('markerLost', () => {
                    this.animation.pause();
                    this.container.style.display = 'none';
                });

                // Add click event listener
                this.container.addEventListener('click', this.onAnimationClick.bind(this));
            },
            onAnimationClick: function() {
                const modelContainer = document.querySelector('#model-container');
                modelContainer.setAttribute('visible', true);
                this.container.style.display = 'none';  // Hide Lottie animation
            },
            tick: function() {
                if (!this.animation) return;

                const plane = this.el.object3D;
                const cam = this.el.sceneEl.camera;

                plane.updateMatrixWorld();
                const canvasPos = new THREE.Vector3();
                canvasPos.setFromMatrixPosition(plane.matrixWorld);
                canvasPos.project(cam);

                const canvas = this.el.sceneEl.canvas;
                const size = 450;

                const x = (canvasPos.x + 1) / 2 * canvas.clientWidth - size / 2;
                const y = (-canvasPos.y + 1) / 2 * canvas.clientHeight - size / 2;

                this.container.style.transform = `translate(${x-200}px, ${y-160}px)`;
                this.container.style.width = `${size}px`;
                this.container.style.height = `${size}px`;
            }
        });

        document.querySelector('#lottie-plane').setAttribute('lottie-animation', '');

        // Add interactivity to the 3D model
        AFRAME.registerComponent('interactive-model', {
            init: function () {
                this.el.addEventListener('click', function (evt) {
                    // Add your interaction logic here
                    this.setAttribute('rotation', {x: 0, y: this.getAttribute('rotation').y + 90, z: 0});
                });
            }
        });

        document.querySelector('#model-container').setAttribute('interactive-model', '');
    </script>
</body>
</html>